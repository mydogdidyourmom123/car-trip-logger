<!DOCTYPE html>
<html>
<head>
    <title>Trip Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 100%; }
        select { margin: 10px; padding: 5px; }
    </style>
</head>
<body>
    <h2>Trip Map Viewer</h2>
    <select id="tripSelect">
        <option value="">Select a trip</option>
        {% for trip in trips %}
        <option value="{{ loop.index0 }}">{{ trip.file }}</option>
        {% endfor %}
    </select>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var trips = {{ trips | tojson }};
        var map = L.map('map').setView([33.7, -86.4], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        var currentLayer;
        var startMarker, endMarker;

        function loadTrip(index) {
            if (currentLayer) map.removeLayer(currentLayer);
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);

            if (index !== "") {
                var coords = trips[index].coords.map(c => [c.lat, c.lon]);
                if (coords.length > 0) {
                    currentLayer = L.polyline(coords, {color: 'blue'}).addTo(map);
                    startMarker = L.marker(coords[0]).addTo(map).bindPopup("Start");
                    endMarker = L.marker(coords[coords.length - 1]).addTo(map).bindPopup("End");
                    map.fitBounds(currentLayer.getBounds());
                }
            }
        }

        document.getElementById('tripSelect').addEventListener('change', function() {
            loadTrip(this.value);
        });

        // Load first trip automatically if available
        if (trips.length > 0) loadTrip(0);
    </script>
</body>
</html>
